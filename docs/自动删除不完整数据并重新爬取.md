# 自动删除不完整数据并重新爬取

## ✅ 新功能

**如果某个笔记的评论或截图不完整，自动删除该笔记的所有数据，然后重新爬取。**

---

## 📊 执行流程

```
启动
  ↓
[检查阶段] 扫描所有已有笔记
  ↓
  检查每个笔记：
    - 评论数量是否 >= 20？
    - 截图文件是否存在？
    - 临时层文件数量？
  ↓
  分类：
    ✅ 完整：有最终截图
    ❌ 不完整：
       - 评论不足 (<20条)
       - 截图不完整 (临时层 <20)
       - 没有截图
  ↓
[删除阶段] 删除不完整笔记的所有数据
  ↓
  对每个不完整的笔记：
    1. 删除 content.csv 中的记录
    2. 删除 comments.csv 中的所有评论
    3. 删除最终截图文件
    4. 删除临时层文件夹
    5. 从已爬取列表中移除
  ↓
[重新爬取阶段] 正常搜索和爬取
  ↓
  这些被删除的笔记会被当作新笔记：
    - 重新爬取内容
    - 重新爬取评论（20条）
    - 重新截图（20层）
```

---

## 🔍 判断标准

### **完整笔记**

```python
完整 = 有最终截图文件 (comments_{note_id}_{timestamp}.png)
```

### **不完整笔记（需要删除重爬）**

```python
不完整 = 以下任一情况：
  1. 评论不足 (<20条) 且 没有临时文件
  2. 有临时文件 但 层数不足 (<20层)
  3. 评论不足 (<20条)
  4. 评论足够 但 没有截图
```

---

## 📋 详细日志示例

```
========== 启动阶段 ==========
[XiaoHongShuCrawler.search] Begin search xiaohongshu keywords

[CrawlProgressManager] Loading crawled note IDs...
[CrawlProgressManager] Loaded 10 crawled note IDs

[XiaoHongShuCrawler.search] Resume crawl enabled:
  - Already crawled 10 notes
  - Already crawled comments for 5 notes

========== 检查阶段 ==========
[XiaoHongShuCrawler.search] 🔍 Checking existing notes for incomplete data...

[_check_and_get_incomplete_screenshots] Reading content from: data/xhs/csv/search_contents_2025-10-17.csv
[_check_and_get_incomplete_screenshots] Reading comments from: data/xhs/csv/search_comments_2025-10-17.csv
[_check_and_get_incomplete_screenshots] Found comments for 3 notes

[_check_and_get_incomplete_screenshots] Note 65e159e5000000000b023480: incomplete screenshot (7/20 layers) - will delete and re-crawl
[_check_and_get_incomplete_screenshots] Note 6770c780000000000b00ca9e: incomplete screenshot (10/20 layers) - will delete and re-crawl
[_check_and_get_incomplete_screenshots] Note 6885ead5000000002203d407: incomplete screenshot (10/20 layers) - will delete and re-crawl
[_check_and_get_incomplete_screenshots] Note 68cbcc45000000001201e94c: complete (comments_68cbcc45000000001201e94c_1760678227936.png)
[_check_and_get_incomplete_screenshots] Note 68ee13210000000005038799: incomplete screenshot (10/20 layers) - will delete and re-crawl

[_check_and_get_incomplete_screenshots] Summary:
  - Total notes in content.csv: 10
  - Notes with complete screenshot: 1
  - Notes without enough comments: 0
  - Notes need screenshot: 4

========== 删除阶段 ==========
[XiaoHongShuCrawler.search] ⚠️  Found 4 notes with incomplete comments or screenshots
[XiaoHongShuCrawler.search] 🗑️  Deleting incomplete data to re-crawl...

[XiaoHongShuCrawler.search] 🗑️  Deleting note 65e159e5000000000b023480 (comments: 0/20, layers: 7)
[CrawlProgressManager] Deleted 1 content record for note 65e159e5000000000b023480
[CrawlProgressManager] Deleted 0 comment records for note 65e159e5000000000b023480
[CrawlProgressManager] Deleted temp directory for note 65e159e5000000000b023480

[XiaoHongShuCrawler.search] 🗑️  Deleting note 6770c780000000000b00ca9e (comments: 13/20, layers: 10)
[CrawlProgressManager] Deleted 1 content record for note 6770c780000000000b00ca9e
[CrawlProgressManager] Deleted 24 comment records for note 6770c780000000000b00ca9e
[CrawlProgressManager] Deleted screenshot: comments_6770c780000000000b00ca9e_1760679951501.png
[CrawlProgressManager] Deleted temp directory for note 6770c780000000000b00ca9e

[XiaoHongShuCrawler.search] 🗑️  Deleting note 6885ead5000000002203d407 (comments: 0/20, layers: 10)
[CrawlProgressManager] Deleted 1 content record for note 6885ead5000000002203d407
[CrawlProgressManager] Deleted 0 comment records for note 6885ead5000000002203d407
[CrawlProgressManager] Deleted screenshot: comments_6885ead5000000002203d407_1760678069272.png
[CrawlProgressManager] Deleted temp directory for note 6885ead5000000002203d407

[XiaoHongShuCrawler.search] 🗑️  Deleting note 68ee13210000000005038799 (comments: 15/20, layers: 10)
[CrawlProgressManager] Deleted 1 content record for note 68ee13210000000005038799
[CrawlProgressManager] Deleted 26 comment records for note 68ee13210000000005038799
[CrawlProgressManager] Deleted screenshot: comments_68ee13210000000005038799_1760679851094.png
[CrawlProgressManager] Deleted temp directory for note 68ee13210000000005038799

[XiaoHongShuCrawler.search] ✅ Deleted 4 incomplete notes, they will be re-crawled

========== 搜索阶段 ==========
[XiaoHongShuCrawler.search] Current search keyword: 雅诗兰黛
[XiaoHongShuCrawler.search] search xhs keyword: 雅诗兰黛, page: 1

[XiaoHongShuCrawler.search] Found 20 notes in search results
[XiaoHongShuCrawler.search] Filtering notes...
  - Note 68cbcc45000000001201e94c: already complete (skip) ✅
  - Note 65e159e5000000000b023480: will crawl (deleted earlier) 🔄
  - Note 6770c780000000000b00ca9e: will crawl (deleted earlier) 🔄
  - Note 6885ead5000000002203d407: will crawl (deleted earlier) 🔄
  - Note 68ee13210000000005038799: will crawl (deleted earlier) 🔄

[XiaoHongShuCrawler.search] 📊 Progress: 0/4 (0.0%) | Crawling notes #1-#4

========== 重新爬取 ==========
[XiaoHongShuCrawler.get_note_detail] Fetching note 65e159e5000000000b023480
[XiaoHongShuCrawler.get_comments] Crawling comments for note 65e159e5000000000b023480
[XiaoHongShuCrawler.screenshot_comments] Screenshotting 20 layers for note 65e159e5000000000b023480

[screenshot_comments_section] Processing layer 1...
[screenshot_comments_section] Processing layer 2...
...
[screenshot_comments_section] Processing layer 20...
[screenshot_comments_section] Successfully captured 20 layers, now stitching...

[XiaoHongShuCrawler.search] ✓ Note #1/4 (25.0%) - 完成
...
```

---

## 🎯 关键特性

### **1. 自动删除所有相关数据**

```python
删除内容：
  ✅ content.csv 中的记录
  ✅ comments.csv 中的所有评论（一级+二级）
  ✅ 最终截图文件
  ✅ 临时层文件夹
  ✅ 已爬取列表中的标记
```

---

### **2. 智能判断不完整**

```python
# 情况1：有临时文件但不完整
临时层文件: 7层 < 20层 → 删除重爬 ❌

# 情况2：评论不足
一级评论: 13条 < 20条 → 删除重爬 ❌

# 情况3：有最终截图
最终截图存在 → 完整，跳过 ✅
```

---

### **3. 完全重新爬取**

```python
删除后的笔记 = 新笔记

会重新：
  ✅ 爬取内容
  ✅ 爬取20条一级评论
  ✅ 爬取每条一级评论的二级评论
  ✅ 截图20层
  ✅ 拼接成长图
```

---

## 🚨 注意事项

### **1. 数据会被永久删除**

```
⚠️  删除操作不可逆！

删除前会显示：
  - 笔记ID
  - 当前评论数量
  - 当前层数

确保你想重新爬取这些笔记
```

---

### **2. 临时文件会触发删除**

```
如果有临时层文件（即使只有1层），
且数量 < 20，就会触发删除重爬。

原因：
  - 临时文件说明截图已开始
  - 但没有完成（没有最终截图）
  - 需要删除重新截图
```

---

### **3. 评论不足也会删除**

```
如果评论数量 < 20条，
会删除所有数据重新爬取。

目的：
  - 确保每个笔记都有20条一级评论
  - 确保截图有20层
```

---

## ✅ 优势

### **对比旧逻辑**

| 特性 | 旧逻辑 | 新逻辑 |
|------|--------|--------|
| **不完整数据** | 保留，尝试补全 | 删除，重新爬取 |
| **临时文件** | 可能导致混乱 | 自动清理 |
| **评论不足** | 跳过 | 删除重爬 |
| **截图不完整** | 尝试补全 | 删除重爬 |
| **数据一致性** | 可能不一致 | 完全一致 |

---

### **用户体验**

```
旧逻辑：
  笔记A：评论10条 + 截图7层 → 跳过 ❌
  结果：数据不完整，无法使用

新逻辑：
  笔记A：评论10条 + 截图7层 → 删除 🗑️
  笔记A：重新爬取 → 评论20条 + 截图20层 ✅
  结果：数据完整，可以使用
```

---

## 🎉 总结

**现在的行为**：

1. ✅ 启动时检查所有笔记
2. ✅ 找出评论或截图不完整的笔记
3. ✅ **删除这些笔记的所有数据**
4. ✅ 重新爬取这些笔记（当作新笔记）
5. ✅ 确保每个笔记都有20条评论+20层截图

**不会出现的问题**：
- ❌ 不会保留不完整的数据
- ❌ 不会尝试补全（直接删除重爬）
- ❌ 不会有临时文件残留
- ❌ 不会有数据不一致

**现在可以放心运行了！** 🎉

# 小红书二级评论获取说明

## 📌 小红书评论展开规则

通过观察小红书的实际页面行为，发现其二级评论展开的规则如下：

### 第一次点击"展开回复"时：

- **如果二级评论总数 > 6条**：会显示 **6条**（原本显示的1条 + 新展开的5条）
- **如果二级评论总数 ≤ 6条**：会显示 **全部**

### 示例

```
一级评论A
  └─ 二级评论1（默认显示）
  └─ 二级评论2（隐藏）
  └─ 二级评论3（隐藏）
  └─ 二级评论4（隐藏）
  └─ 二级评论5（隐藏）
  └─ 二级评论6（隐藏）
  └─ 二级评论7（隐藏）
  └─ 二级评论8（隐藏）
  [展开回复] ← 点击后显示评论2-6，评论7-8仍隐藏
```

## ⚙️ 配置方法

在 `config/base_config.py` 中设置：

```python
# 爬取二级评论的数量控制(单个一级评论下)
# 设置为6可以获取"第一次点击展开"后的所有评论
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 6
```

### 配置选项说明

| 配置值 | 说明 | 效果 |
|--------|------|------|
| `6` | 推荐设置 | 获取第一次展开后显示的所有评论（模拟真实用户行为） |
| `0` | 不限制 | 获取所有二级评论（需要多次API调用） |
| 其他数字 | 自定义 | 获取指定数量的二级评论 |

## 🚀 使用示例

### 1. 基本使用（推荐配置）

```python
# config/base_config.py
ENABLE_GET_SUB_COMMENTS = True
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 6
```

运行程序后，会自动获取：
- ✅ 所有一级评论
- ✅ 每个一级评论的前6条二级评论（第一次展开的数量）

### 2. 获取所有二级评论

如果需要获取更多的二级评论：

```python
# config/base_config.py
ENABLE_GET_SUB_COMMENTS = True
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 0  # 0表示不限制
```

注意：这会增加API调用次数和爬取时间。

### 3. 不获取二级评论

```python
# config/base_config.py
ENABLE_GET_SUB_COMMENTS = False
```

## 📊 实际效果对比

### 配置为 6（推荐）

```
✅ 获取速度：快
✅ API调用：少
✅ 符合用户实际浏览行为
✅ 数据完整性：第一次展开的所有内容

示例输出：
- 一级评论: 50条
- 二级评论: 最多 50 × 6 = 300条
```

### 配置为 0（不限制）

```
⚠️ 获取速度：慢
⚠️ API调用：多
⚠️ 可能增加被限制的风险
✅ 数据完整性：所有二级评论

示例输出：
- 一级评论: 50条
- 二级评论: 可能 > 1000条（取决于实际评论数）
```

## 💡 推荐实践

### 场景1：快速数据采集
```python
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 20  # 只获取20条一级评论
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 6  # 每条获取6条二级评论
```
**结果**：约 20 + 120 = 140条评论

### 场景2：完整评论分析
```python
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 50  # 获取50条一级评论
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 6  # 每条获取6条二级评论
```
**结果**：约 50 + 300 = 350条评论

### 场景3：深度数据挖掘
```python
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 100  # 获取100条一级评论
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 0  # 获取所有二级评论
```
**结果**：所有评论（时间较长）

## 🔍 技术原理

代码中的实现逻辑：

```python
# media_platform/xhs/client.py

async def get_comments_all_sub_comments(...):
    """
    获取指定一级评论下的二级评论
    
    小红书页面展开规则：
    - 总数 > 6条 → 第一次展开显示6条
    - 总数 ≤ 6条 → 第一次展开显示全部
    """
    max_sub_comments = config.CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT
    
    # 如果设置为6，只获取前6条
    if max_sub_comments > 0 and sub_comments_count >= max_sub_comments:
        break
```

## 📈 数据统计示例

运行后可以看到如下日志：

```
[XiaoHongShuCrawler] Begin get note id comments 65f1234567890abc
[XiaoHongShuClient] Fetching primary comments...
[XiaoHongShuClient] Found 25 primary comments
[XiaoHongShuClient] Fetching sub-comments for comment 1/25
[XiaoHongShuClient] Got 6 sub-comments (limit: 6)
[XiaoHongShuClient] Fetching sub-comments for comment 2/25
[XiaoHongShuClient] Got 3 sub-comments (total < 6, all loaded)
...
[XiaoHongShuCrawler] Total comments: 25 primary + 127 sub = 152 total
```

## ⚠️ 注意事项

1. **反爬虫限制**
   - 合理设置 `CRAWLER_MAX_SLEEP_SEC`（建议2-5秒）
   - 不要频繁大量爬取
   - 使用已登录的账号

2. **数据准确性**
   - 设置为6可以精确匹配"第一次展开"的行为
   - 如需更多数据，设置为0或更大的数值

3. **性能考虑**
   - 二级评论数量越多，爬取时间越长
   - 建议根据实际需求调整配置

## 🎯 常见问题

### Q1: 为什么我获取不到6条二级评论？

**A:** 可能的原因：
- 该一级评论本身的二级评论总数 < 6条
- API返回数据不完整（网络问题或被限制）
- 检查日志输出查看实际获取情况

### Q2: 如何验证配置是否生效？

**A:** 查看CSV输出文件：
```bash
# 统计二级评论数量
在 data/xhs/csv/search_comments_*.csv 中查看
每个一级评论最多应该有6条二级评论（如果总数>6）
```

### Q3: 可以针对不同笔记设置不同的数量吗？

**A:** 当前版本使用统一配置。如需自定义，可以修改代码：

```python
# 在调用时传入自定义参数
await self.xhs_client.get_note_all_comments(
    note_id=note_id,
    max_sub_comments=6,  # 自定义数量
)
```

## 📚 相关文档

- [项目主README](../README.md)
- [常见问题](常见问题.md)
- [配置说明](../config/base_config.py)

## 📝 更新日志

- **2025-10-15**: 发现并记录小红书二级评论展开规则
- **2025-10-15**: 更新配置默认值为6
- **2025-10-15**: 添加代码注释说明

---

**提示**：如果你发现小红书的展开规则有变化，请及时更新此文档和配置！



# 评论完整性检查功能说明

## 🎯 你的需求

**目标**：
- 爬取前10条一级评论
- 每条一级评论展开一次，获取所有二级评论
- 生成包含所有评论的完整截图

**问题**：
- 爬到第5条一级评论时中断
- 此时有5条一级评论 + 若干二级评论
- 截图不完整

**期望**：
- 重新运行时，删除不完整的评论
- 重新爬取完整的10条一级评论 + 所有二级评论
- 生成完整截图

---

## ✅ 解决方案

### **核心逻辑：只检查一级评论数量**

```python
# 判断标准
一级评论数量 >= 10  → 完整 ✅ 跳过
一级评论数量 < 10   → 不完整 ⚠️ 清理并重新爬取
```

**为什么只检查一级评论？**
- 二级评论数量是动态的（每条一级评论的二级评论数不同）
- 一级评论数量是固定的（配置为10条）
- 只要一级评论完整，二级评论和截图就会完整

---

## 🔄 工作流程

### **场景：中途中断**

```
第一次运行：
  爬取笔记A
    ↓
  爬取一级评论：1, 2, 3, 4, 5 【中断】
    ↓
  爬取二级评论：
    - 评论1的3条二级评论
    - 评论2的5条二级评论
    - 评论3的2条二级评论
    - 评论4的0条二级评论
    - 评论5的1条二级评论
    ↓
  comments.csv:
    - 5条一级评论 ⚠️
    - 11条二级评论
    - 总计16条
    ↓
  截图：未生成（因为中断）
```

---

### **第二次运行：自动清理并重新爬取**

```
启动程序
  ↓
检查评论完整性
  ↓
笔记A：
  - 一级评论：5条 < 10条 ⚠️
  - 总评论：16条（5一级 + 11二级）
  ↓
【自动清理】删除笔记A的所有16条评论
  ↓
重新爬取笔记A
  ↓
爬取一级评论：1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ✅
  ↓
爬取二级评论：
  - 评论1的3条
  - 评论2的5条
  - ...
  - 评论10的4条
  ↓
生成完整截图 ✅
  ↓
comments.csv:
  - 10条一级评论 ✅
  - 35条二级评论
  - 总计45条
```

---

## 📊 日志示例

### **启动时**

```
[CrawlProgressManager] Comment crawl status:
  - Complete notes (>=10 primary comments): 15
  - Incomplete notes (<10 primary comments): 3
    - note_001: 5 primary + 11 sub = 16 total
    - note_002: 7 primary + 18 sub = 25 total
    - note_003: 3 primary + 5 sub = 8 total

[CrawlProgressManager] Cleaned incomplete comments:
  - Incomplete notes: 3
  - Deleted comment rows: 49
  - Backup saved to: data/xhs/csv/search_comments_2025-10-17.csv.backup

[XiaoHongShuCrawler.search] 🧹 Auto-cleaned 49 incomplete comment rows

[XiaoHongShuCrawler.search] Resume crawl enabled:
  - Already crawled 50 notes
  - Already crawled comments for 15 notes
```

**解读**：
- 15个笔记的评论完整（一级评论 >= 10条）
- 3个笔记的评论不完整（一级评论 < 10条）
- 自动删除了49条评论（包括一级和二级）
- 这3个笔记会重新爬取

---

## ⚙️ 配置选项

### **config.py**

```python
# 一级评论数量（判断完整性的标准）
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 10

# 二级评论数量（每条一级评论下）
# 6 = 模拟"第一次点击展开"的效果
CRAWLER_MAX_SUB_COMMENTS_COUNT_PER_COMMENT = 6

# 是否自动清理不完整的评论
ENABLE_AUTO_CLEAN_INCOMPLETE_COMMENTS = True  # 推荐开启

# 是否启用断点续爬
ENABLE_RESUME_CRAWL = True
```

---

## 🎯 关键点

### **1. 只统计一级评论**

```python
# 判断是否为一级评论
parent_comment_id = row.get('parent_comment_id', '')
if not parent_comment_id or parent_comment_id == '':
    # 这是一级评论
    primary_count += 1
```

### **2. 删除所有评论（包括二级）**

```python
# 找出不完整的笔记
if primary_count < 10:
    incomplete_note_ids.add(note_id)

# 删除该笔记的所有评论（一级 + 二级）
filtered_rows = [row for row in all_rows 
                 if row.get('note_id') not in incomplete_note_ids]
```

### **3. 重新爬取时会获取完整评论**

```python
# 爬取10条一级评论
for i in range(10):
    crawl_primary_comment(i)
    # 每条一级评论展开一次，获取二级评论
    crawl_sub_comments(i, max_count=6)

# 生成完整截图
screenshot_all_comments()
```

---

## 📁 文件备份

清理前会自动备份：

```
data/xhs/csv/search_comments_2025-10-17.csv          # 清理后的文件
data/xhs/csv/search_comments_2025-10-17.csv.backup  # 备份文件
```

如果清理错误，可以恢复备份：

```bash
cp search_comments_2025-10-17.csv.backup search_comments_2025-10-17.csv
```

---

## ✅ 总结

**完整性判断标准**：
- ✅ 一级评论数量 >= 10 → 完整
- ⚠️ 一级评论数量 < 10 → 不完整

**自动处理**：
- 启动时检查
- 自动清理不完整的评论（包括二级）
- 重新爬取并生成完整截图

**配置**：
```python
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 10  # 一级评论目标数量
ENABLE_AUTO_CLEAN_INCOMPLETE_COMMENTS = True  # 自动清理
```

现在你可以放心爬取了！即使中途中断，下次运行会自动清理不完整的评论并重新爬取！🎉

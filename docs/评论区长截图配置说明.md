# 小红书评论区长截图配置说明

## 📸 功能说明

此功能可以对小红书笔记的评论区进行**长截图**，包括：
- ✅ 一级评论（主评论）
- ✅ 展开后的二级评论（回复）
- ✅ 可控制截图的评论数量（层数）

## ⚙️ 配置方法

在 `config/base_config.py` 中设置：

```python
# 是否开启评论截图模式
ENABLE_GET_COMMENTS_SCREENSHOT = True

# 截图包含的一级评论数量（层数）
SCREENSHOT_COMMENTS_COUNT = 20  # 截取前20条一级评论
# SCREENSHOT_COMMENTS_COUNT = 30  # 或者截取前30条
# SCREENSHOT_COMMENTS_COUNT = 0   # 0表示截取所有加载的评论
```

## 🎯 配置选项

### 1. 截取前20层楼（20条一级评论+二级评论）

```python
SCREENSHOT_COMMENTS_COUNT = 20
```

**效果：**
- 加载所有一级评论
- 只对前20条一级评论点击"展开回复"
- 截图包含：20条一级评论 + 它们的二级评论

### 2. 截取前30层楼（30条一级评论+二级评论）

```python
SCREENSHOT_COMMENTS_COUNT = 30
```

**效果：**
- 加载所有一级评论
- 只对前30条一级评论点击"展开回复"
- 截图包含：30条一级评论 + 它们的二级评论

### 3. 截取所有评论

```python
SCREENSHOT_COMMENTS_COUNT = 0  # 0表示不限制
```

**效果：**
- 加载所有一级评论
- 对所有一级评论点击"展开回复"
- 截图包含：所有一级评论 + 所有二级评论

## 🚀 完整配置示例

### 示例1：截取20层楼

```python
# config/base_config.py

# 基础配置
KEYWORDS = "雅诗兰黛"
CRAWLER_MAX_NOTES_COUNT = 3  # 爬取3条笔记

# 评论配置
ENABLE_GET_COMMENTS = True
ENABLE_GET_COMMENTS_SCREENSHOT = True  # 开启截图

# 截图配置
SCREENSHOT_COMMENTS_COUNT = 20  # 截取20层楼

# 其他配置
HEADLESS = False  # 显示浏览器方便观察
CRAWLER_MAX_SLEEP_SEC = 2
```

### 示例2：截取30层楼

```python
SCREENSHOT_COMMENTS_COUNT = 30  # 截取30层楼
```

## 📊 工作流程

```
1. 打开笔记页面
   ↓
2. 点击"展开更多评论"按钮（加载所有一级评论）
   ↓
3. 获取前N条一级评论元素（N=配置的数量）
   ↓
4. 遍历每个一级评论：
   ├─ 滚动到该评论可见
   ├─ 查找"展开回复"按钮
   ├─ 点击按钮
   └─ 等待二级评论加载（0.8秒）
   ↓
5. 等待所有二级评论加载完成（1秒）
   ↓
6. 对整个评论区进行长截图
   ↓
7. 保存截图文件
   ↓
8. 更新CSV的comments_screenshot字段
```

## 🎨 截图效果对比

### 设置为20层楼
```
截图内容：
├─ 一级评论1 + 二级评论（展开）
├─ 一级评论2 + 二级评论（展开）
├─ ...
├─ 一级评论20 + 二级评论（展开）
├─ 一级评论21（不展开）
├─ 一级评论22（不展开）
└─ ...
```

### 设置为30层楼
```
截图内容：
├─ 一级评论1 + 二级评论（展开）
├─ 一级评论2 + 二级评论（展开）
├─ ...
├─ 一级评论30 + 二级评论（展开）
├─ 一级评论31（不展开）
└─ ...
```

### 设置为0（全部）
```
截图内容：
├─ 一级评论1 + 二级评论（展开）
├─ 一级评论2 + 二级评论（展开）
├─ ...
└─ 一级评论N + 二级评论（展开）
```

## 📝 日志输出示例

运行时会看到类似日志：

```
[screenshot_comments_section] Starting to screenshot comment section for note: 66810...
[screenshot_comments_section] Loading all primary comments...
[screenshot_comments_section] Clicking load more button (attempt 1)
[screenshot_comments_section] No more load more buttons found
[screenshot_comments_section] Expanding sub-comments for comments (target: 20 comments)...
[screenshot_comments_section] Found 50 comments, will expand 20 comments
[screenshot_comments_section] Expanded sub-comments for comment 1/20
[screenshot_comments_section] Expanded sub-comments for comment 2/20
...
[screenshot_comments_section] Expanded sub-comments for comment 20/20
[screenshot_comments_section] Expanded 15 comments with sub-comments
[screenshot_comments_section] Taking screenshot of comment section...
[screenshot_comments_section] Screenshot saved: data/xhs/screenshots/comments_66810..._.png
```

## ⏱️ 时间预估

### 截取20层楼
- 加载评论：5-10秒
- 展开20个二级评论：20条 × 1秒 = 20秒
- 截图保存：2-3秒
- **总计：约27-33秒/笔记**

### 截取30层楼
- 加载评论：5-10秒
- 展开30个二级评论：30条 × 1秒 = 30秒
- 截图保存：2-3秒
- **总计：约37-43秒/笔记**

### 截取所有（假设50条）
- 加载评论：5-10秒
- 展开50个二级评论：50条 × 1秒 = 50秒
- 截图保存：2-3秒
- **总计：约57-63秒/笔记**

## ⚠️ 注意事项

### 1. 截图数量建议

| 截图数量 | 适用场景 | 时间 | 文件大小 |
|---------|---------|------|----------|
| 10层 | 快速预览 | ~17秒 | ~500KB |
| 20层 | **推荐** | ~30秒 | ~1MB |
| 30层 | 详细分析 | ~40秒 | ~1.5MB |
| 50+层 | 完整记录 | ~60秒+ | ~2MB+ |

### 2. 性能影响

截图数量越多：
- ✅ 截图更完整
- ❌ 爬取时间更长
- ❌ 截图文件更大
- ❌ 更容易被检测

### 3. 最佳实践

**推荐配置：**
```python
SCREENSHOT_COMMENTS_COUNT = 20  # 大多数情况下足够
CRAWLER_MAX_SLEEP_SEC = 3  # 适当增加间隔时间
```

**测试时：**
```python
CRAWLER_MAX_NOTES_COUNT = 1  # 只测试1条
SCREENSHOT_COMMENTS_COUNT = 5  # 只截5层
HEADLESS = False  # 观察过程
```

### 4. 常见问题

**Q: 为什么有些评论没有展开？**
A: 可能原因：
- 该评论没有二级评论
- "展开回复"按钮未被识别
- 页面加载慢，按钮还没出现

**Q: 截图不完整怎么办？**
A: 
- 增加 `CRAWLER_MAX_SLEEP_SEC` 时间
- 减少 `SCREENSHOT_COMMENTS_COUNT` 数量
- 设置 `HEADLESS = False` 观察过程

**Q: 截图太大怎么办？**
A:
- 减少 `SCREENSHOT_COMMENTS_COUNT` 数量
- 后期可以压缩图片

## 🔍 CSV文件查看

运行后，在 `data/xhs/csv/search_contents_*.csv` 中：

```csv
note_id,...,comments_screenshot
66810..,...,data/xhs/screenshots/comments_66810..._.png
```

打开图片就能看到完整的评论区截图，包含展开的二级评论！

## 💡 使用技巧

### 1. 批量测试

先测试1条笔记，确认效果后再批量运行：

```python
# 测试阶段
CRAWLER_MAX_NOTES_COUNT = 1
SCREENSHOT_COMMENTS_COUNT = 10

# 确认OK后正式运行
CRAWLER_MAX_NOTES_COUNT = 20
SCREENSHOT_COMMENTS_COUNT = 20
```

### 2. 分批运行

如果要爬取大量笔记，建议分批：

```python
# 第1批：笔记1-10
CRAWLER_MAX_NOTES_COUNT = 10

# 第2批：笔记11-20
START_PAGE = 2  # 从第2页开始
CRAWLER_MAX_NOTES_COUNT = 10
```

### 3. 后期处理

可以用Python批量处理截图：

```python
from PIL import Image

# 压缩图片
img = Image.open('screenshot.png')
img.save('compressed.png', optimize=True, quality=85)

# 调整尺寸
img.thumbnail((1200, 6000))
img.save('resized.png')
```

## 📚 相关文档

- [评论区截图功能说明](评论区截图功能说明.md)
- [小红书二级评论获取说明](小红书二级评论获取说明.md)
- [配置文件](../config/base_config.py)

---

**提示：首次使用建议设置为20层楼，这是时间和完整性的最佳平衡！**


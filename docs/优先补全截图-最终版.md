# 优先补全截图 - 最终版

## ✅ 已实现功能

### **执行顺序**

```
启动
  ↓
[阶段1] 检查已有笔记
  ↓
  从 content.csv 读取所有笔记
  从 comments.csv 统计评论数量
  检查截图文件是否存在
  ↓
  找出：需要补全截图的笔记
  ↓
[阶段2] 补全旧笔记截图（优先）⭐
  ↓
  ⏸️  暂停新内容爬取
  ↓
  逐个打开旧笔记URL
  截图 → 保存 → 标记完成
  ↓
  ✅ 全部补全完成
  ↓
[阶段3] 搜索和爬取新笔记
  ↓
  正常搜索关键词
  爬取新笔记
```

---

## 📊 详细日志示例

### **启动阶段**

```
[XiaoHongShuCrawler.search] Begin search xiaohongshu keywords

[CrawlProgressManager] Loading crawled note IDs...
[CrawlProgressManager] Loaded 6 crawled note IDs

[CrawlProgressManager] Loading crawled comment note IDs...
[CrawlProgressManager] Comment crawl status:
  - Complete notes (>=20 primary comments + screenshot): 0
  - Incomplete notes (<20 primary comments): 0

[XiaoHongShuCrawler.search] Resume crawl enabled:
  - Already crawled 6 notes
  - Already crawled comments for 0 notes
```

---

### **检查阶段**

```
[XiaoHongShuCrawler.search] 🔍 Checking existing notes for missing screenshots...

[_check_and_get_incomplete_screenshots] Reading content from: data/xhs/csv/search_contents_2025-10-17.csv
[_check_and_get_incomplete_screenshots] Reading comments from: data/xhs/csv/search_comments_2025-10-17.csv
[_check_and_get_incomplete_screenshots] Found comments for 6 notes

[_check_and_get_incomplete_screenshots] Note 65e159e5: needs screenshot (comments: 20/20, layers: 0)
[_check_and_get_incomplete_screenshots] Note 6885ead5: needs screenshot (comments: 20/20, layers: 3)
[_check_and_get_incomplete_screenshots] Note 68cbcc45: needs screenshot (comments: 20/20, layers: 0)

[_check_and_get_incomplete_screenshots] Summary:
  - Total notes in content.csv: 6
  - Notes with complete screenshot: 0
  - Notes without enough comments: 0
  - Notes need screenshot: 6
```

---

### **补全阶段（优先）**

```
[XiaoHongShuCrawler.search] 📸 Found 6 existing notes need screenshot completion
[XiaoHongShuCrawler.search] 📸 Completing screenshots BEFORE searching new notes...
[XiaoHongShuCrawler.search] ⏸️  Pausing new content crawling until screenshots are complete

[XiaoHongShuCrawler._complete_existing_screenshots] Begin completing 6 screenshots

[XiaoHongShuCrawler._complete_existing_screenshots] (1/6) Processing note 65e159e5
  - Comments: 20/20
  - Current layers: 0

[screenshot_comments_section] Opening URL: https://www.xiaohongshu.com/explore/65e159e5?xsec_token=...
[screenshot_comments_section] Starting layer-by-layer screenshot (target: 20 comments)
[screenshot_comments_section] Will attempt to load more comments up to 2 times (target: 20 comments)
[screenshot_comments_section] Clicking primary comments load more button (attempt 1)
[screenshot_comments_section] Clicking primary comments load more button (attempt 2)
[screenshot_comments_section] No more primary comment load buttons found after 2 attempts

[screenshot_comments_section] Validating 25 parent comment elements...
[screenshot_comments_section] Found 20 valid parent comments out of 25 elements
[screenshot_comments_section] Will screenshot 20 parent comments (layer by layer)

[screenshot_comments_section] Processing layer 1:
  - Index in list: 0
  - Expected ID: comment-65e159e5-001
  - Actual ID: comment-65e159e5-001
  - Content: 这款面霜真的很好用，推荐给大家...

[screenshot_comments_section] Layer 1: Found expand button '展开回复' (clicking ONCE only)
[screenshot_comments_section] Layer 1: ✓ Expanded from 1 to 6 sub-comments (clicked once)
[screenshot_comments_section] Layer 1/20 screenshot saved

[screenshot_comments_section] Processing layer 2:
...

[screenshot_comments_section] Processing layer 20:
...

[screenshot_comments_section] Successfully captured 20 layers (target was 20), now stitching...
[screenshot_comments_section] Using original images without cropping
[screenshot_comments_section] Stitched long image saved: comments_65e159e5_1729134000.png

[XiaoHongShuCrawler._complete_existing_screenshots] ✓ Screenshot completed: comments_65e159e5_1729134000.png

[XiaoHongShuCrawler._complete_existing_screenshots] (2/6) Processing note 6885ead5
...

[XiaoHongShuCrawler._complete_existing_screenshots] (6/6) Processing note 68cbcc45
...

[XiaoHongShuCrawler.search] ✅ Screenshot completion finished, now starting to search new notes
```

---

### **搜索阶段（之后）**

```
[XiaoHongShuCrawler.search] Current search keyword: 雅诗兰黛
[XiaoHongShuCrawler.search] search xhs keyword: 雅诗兰黛, page: 1

[XiaoHongShuCrawler.search] Found 20 notes in search results
[XiaoHongShuCrawler.search] Filtering notes...
  - Note 65e159e5: already complete (skip) ✅
  - Note 6885ead5: already complete (skip) ✅
  - Note 87654321: new note (will crawl)
  - Note 11111111: new note (will crawl)

[XiaoHongShuCrawler.search] 💬 Crawling comments for 2 notes
...
```

---

## 🎯 关键特性

### **1. 不会先保存新内容**

```python
# 执行顺序
if 有缺失截图的旧笔记:
    先补全旧笔记截图 ✅
    暂停新内容爬取 ⏸️
else:
    开始搜索新笔记 🔍
```

---

### **2. 从 content.csv 直接读取**

```python
# 不需要重新搜索
with open('content.csv') as f:
    for row in reader:
        note_id = row['note_id']
        xsec_token = row['xsec_token']
        note_url = row['note_url']
        
        # 直接打开URL截图
        await screenshot(note_url)
```

---

### **3. 详细的检查日志**

```
Summary:
  - Total notes in content.csv: 6
  - Notes with complete screenshot: 0
  - Notes without enough comments: 0
  - Notes need screenshot: 6
```

---

### **4. 使用 Playwright 直接打开URL**

```python
# 构建URL
if note_url:
    use note_url  # 优先使用保存的URL
else:
    note_url = f"https://www.xiaohongshu.com/explore/{note_id}"
    if xsec_token:
        note_url += f"?xsec_token={xsec_token}"

# 使用 Playwright 打开
await page.goto(note_url)
await screenshot_comments_section()
```

---

## 🚨 注意事项

### **1. 只补全评论完整的笔记**

```
评论不完整（<20条）：
  ❌ 跳过，不补全截图
  ⚠️  需要重新爬取评论

评论完整（>=20条）：
  ✅ 补全截图
  ✅ 不重新爬取评论
```

---

### **2. 截图计数已修复**

```python
# 旧逻辑（有bug）
successful_screenshots += 1  # 先递增
await screenshot()  # 可能失败
# 结果：失败后计数错误，导致缺层

# 新逻辑（已修复）
await screenshot()  # 先截图
successful_screenshots += 1  # 成功后才递增
# 结果：只有成功的才计数，不会缺层
```

---

### **3. 临时文件已隔离**

```
data/xhs/screenshots/temp/
  ├── 65e159e5/  ✅ 笔记A专属
  │   ├── layer_1_65e159e5.png
  │   └── layer_2_65e159e5.png
  └── 6885ead5/  ✅ 笔记B专属
      ├── layer_1_6885ead5.png
      └── layer_2_6885ead5.png
```

---

## ✅ 总结

**现在的执行流程**：

1. ✅ **启动时检查** content.csv 中的所有笔记
2. ✅ **优先补全**缺失截图的旧笔记
3. ✅ **暂停新内容爬取**，直到旧笔记截图完成
4. ✅ **使用 Playwright** 直接打开URL截图
5. ✅ **补全完成后**，才开始搜索新笔记

**不会出现的问题**：
- ❌ 不会先爬取新内容
- ❌ 不会先保存新评论
- ❌ 不会混合处理新旧笔记
- ❌ 不会缺少截图层

**现在可以放心运行了！** 🎉

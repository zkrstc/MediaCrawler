# 截图层数和智能续爬说明

## 🎯 问题1：为什么只有10层截图？

### **原因分析**

截图层数取决于**页面上实际加载的评论数量**，而不是配置的数量。

```python
# 你的配置
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 20  # 爬取20条
SCREENSHOT_COMMENTS_COUNT = 20               # 截图20层

# 但实际截图时
页面上只加载了10条评论 → 只能截图10层
```

### **为什么页面只加载10条？**

小红书默认只显示10条评论，需要点击"展开更多评论"按钮才能加载更多。

**旧逻辑**：
```python
max_load_more_attempts = 10  # 固定点击10次
```

**问题**：
- 点击10次可能不够加载20条评论
- 或者页面上没有那么多评论

---

## ✅ 解决方案1：动态调整加载次数

**已修复！** 现在会根据目标评论数量动态调整：

```python
# 新逻辑（client.py 第719行）
# 小红书每次加载10条，所以需要点击 (20 + 9) // 10 = 2 次
max_load_more_attempts = max(10, (screenshot_count + 9) // 10)

# 示例：
SCREENSHOT_COMMENTS_COUNT = 20 → 点击 2 次
SCREENSHOT_COMMENTS_COUNT = 30 → 点击 3 次
SCREENSHOT_COMMENTS_COUNT = 50 → 点击 5 次
```

**日志输出**：
```
[screenshot_comments_section] Will attempt to load more comments up to 2 times (target: 20 comments)
[screenshot_comments_section] Clicking primary comments load more button (attempt 1)
[screenshot_comments_section] Clicking primary comments load more button (attempt 2)
[screenshot_comments_section] No more primary comment load buttons found after 2 attempts
```

---

## 🎯 问题2：评论完整但缺截图，如何自动补全？

### **场景描述**

```
第一次运行：
  爬取笔记A的20条评论 ✅
  截图到第5层时【中断】❌
  
结果：
  - comments.csv: 20条一级评论 ✅
  - 截图: 无 ❌

第二次运行（旧逻辑）：
  检查：评论20条 >= 20 ✅ + 截图无 ❌
  判定：不完整 → 重新爬取评论 ⚠️
  
问题：
  - 评论已经完整了，不需要重新爬取
  - 只需要补全截图即可
```

---

## ✅ 解决方案2：智能续爬（只截图，不重新爬取）

**已修复！** 现在会智能判断：

```python
# 新逻辑（core.py 第243-286行）
for note_id in note_ids:
    if not is_comment_crawled(note_id):
        # 检查评论是否完整（只缺截图）
        if check_comment_complete(note_id):
            # 评论完整但缺截图 → 只截图 ✅
            notes_to_screenshot_only.append(note_id)
        else:
            # 评论不完整 → 重新爬取 ⚠️
            notes_to_crawl_comments.append(note_id)

# 处理只需要截图的笔记
if notes_to_screenshot_only:
    await batch_screenshot_comments(notes_to_screenshot_only)

# 处理需要爬取评论的笔记
if notes_to_crawl_comments:
    await batch_get_note_comments(notes_to_crawl_comments)
```

---

## 📊 完整流程示例

### **第一次运行（截图中断）**

```
爬取笔记A：
  1. 爬取20条一级评论 ✅
  2. 保存到 comments.csv ✅
  3. 开始截图...
  4. layer_1.png ✅
  5. layer_2.png ✅
  6. layer_3.png 【中断】❌

结果：
  - comments.csv: 20条一级评论 ✅
  - 截图: 无（拼接未完成）❌
```

---

### **第二次运行（智能续爬）**

```
启动检查：
  - content.csv: 笔记A存在 ✅
  - comments.csv: 笔记A有20条一级评论 ✅
  - 截图: 不存在 ❌

智能判断：
  评论完整 + 截图缺失 → 只需要截图 ✅

执行：
  📸 Found 1 notes with complete comments but missing screenshots
  📸 Screenshotting note A
  
  1. 打开笔记页面
  2. 加载20条评论（点击"展开更多"2次）
  3. 逐层截图20层
  4. 拼接成长图 ✅
  5. 保存截图路径
  6. 标记为已完成

结果：
  - comments.csv: 20条一级评论（不变）✅
  - 截图: comments_A_timestamp.png ✅
```

---

## 🎯 三种情况的处理

| 情况 | 评论状态 | 截图状态 | 处理方式 |
|------|---------|---------|---------|
| **情况1** | 完整 ✅ | 存在 ✅ | 跳过 |
| **情况2** | 完整 ✅ | 缺失 ❌ | **只截图** ⭐ |
| **情况3** | 不完整 ❌ | 缺失 ❌ | 重新爬取 + 截图 |

---

## 📊 日志示例

### **情况2：只需要截图**

```
[XiaoHongShuCrawler.search] ✅ Batch completed: 2/2 notes saved successfully

[XiaoHongShuCrawler.search] 📸 Found 1 notes with complete comments but missing screenshots

[XiaoHongShuCrawler.batch_screenshot_comments] Begin batch screenshot for 1 notes
[XiaoHongShuCrawler.batch_screenshot_comments] Screenshotting note 65e159e5

[screenshot_comments_section] Will attempt to load more comments up to 2 times (target: 20 comments)
[screenshot_comments_section] Clicking primary comments load more button (attempt 1)
[screenshot_comments_section] Clicking primary comments load more button (attempt 2)
[screenshot_comments_section] Found 20 valid parent comments

[screenshot_comments_section] Will screenshot 20 parent comments (layer by layer)
[screenshot_comments_section] Processing layer 1...
[screenshot_comments_section] Processing layer 2...
...
[screenshot_comments_section] Processing layer 20...

[screenshot_comments_section] Successfully captured 20 layers, now stitching...
[screenshot_comments_section] Stitched long image saved: comments_65e159e5_1729134000.png

[XiaoHongShuCrawler.batch_screenshot_comments] Screenshot saved: comments_65e159e5_1729134000.png
```

---

## ⚙️ 配置建议

```python
# config.py

# 爬取20条一级评论
CRAWLER_MAX_COMMENTS_COUNT_SINGLENOTES = 20

# 截图20层（应该与爬取数量一致）
SCREENSHOT_COMMENTS_COUNT = 20

# 或者设置为0表示截取所有已加载的评论
SCREENSHOT_COMMENTS_COUNT = 0
```

---

## 🚨 注意事项

### **1. 页面可能没有那么多评论**

如果笔记本身只有10条评论，即使配置了20条，也只能截图10层。

**日志示例**：
```
[screenshot_comments_section] Found 10 valid parent comments out of 15 elements
[screenshot_comments_section] Will screenshot 10 parent comments (target was 20)
```

### **2. 加载更多按钮可能不存在**

如果评论数量少于10条，页面上不会有"展开更多评论"按钮。

**日志示例**：
```
[screenshot_comments_section] No more primary comment load buttons found after 0 attempts
```

### **3. 评论完整性检查**

只统计一级评论数量，不包括二级评论：

```python
# 检查逻辑
primary_count = 0
for row in comments.csv:
    if parent_comment_id == '':  # 一级评论
        primary_count += 1

return primary_count >= 20  # 达标
```

---

## ✅ 总结

**修复内容**：

1. ✅ **动态加载评论**
   - 根据目标数量自动调整点击次数
   - 确保页面加载足够的评论

2. ✅ **智能续爬**
   - 评论完整 + 截图缺失 → 只截图
   - 评论不完整 → 重新爬取 + 截图
   - 评论完整 + 截图存在 → 跳过

3. ✅ **避免重复爬取**
   - 不会重复爬取已完整的评论
   - 只补全缺失的截图

**现在你可以放心爬取了！** 🎉

- 截图会加载足够的评论（20层）
- 中断后会智能续爬（只截图，不重新爬取评论）
- 不会浪费时间重复爬取已有的数据
